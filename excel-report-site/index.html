<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Excel → Report</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;max-width:900px;margin:28px auto;padding:12px}
    label{display:block;margin-top:10px}
    button,input,select{padding:8px;margin-top:6px;width:100%}
    #cols {min-height:120px; border:1px solid #eee; padding:10px}
  </style>
</head>
<body>
  <h1>Excel → Word Report & Dashboard</h1>

  <label>1) Pick Excel file (first upload will return columns)
    <input id="fileInput" type="file" accept=".xlsx,.xls"/>
  </label>
  <button id="getColsBtn">Get Columns from file</button>

  <div id="colsArea"></div>

  <label>Chart type
    <select id="chartType">
      <option value="bar">Bar</option>
      <option value="line">Line</option>
      <option value="pie">Pie</option>
      <option value="scatter">Scatter</option>
    </select>
  </label>

  <label>Recipient email
    <input id="email" type="email" placeholder="you@example.com"/>
  </label>

  <button id="submitBtn">Generate Report & Send Email</button>

  <div id="status" style="margin-top:14px;color:#333"></div>

<script>
// Replace with your actual POST webhook endpoints in n8n
const GET_COLS_URL = "https://n8n-212x.onrender.com/webhook/get-columns"; 
const GENERATE_URL = "https://n8n-212x.onrender.com/webhook/generate-report";

const fileInput = document.getElementById('fileInput');
const getColsBtn = document.getElementById('getColsBtn');
const colsArea = document.getElementById('colsArea');
const submitBtn = document.getElementById('submitBtn');
const status = document.getElementById('status');

let lastFile = null;
let availableColumns = [];

getColsBtn.addEventListener('click', async () => {
  status.innerText = '';
  lastFile = fileInput.files[0];
  if (!lastFile) { alert('Choose an Excel file first'); return; }

  const fd = new FormData();
  fd.append('file', lastFile); // 'file' must match webhook node's binary field name

  status.innerText = 'Uploading file to get columns...';
  try {
    const r = await fetch(GET_COLS_URL, { method: 'POST', body: fd }); // Always POST
    if (!r.ok) {
      status.innerText = `Get-columns request failed: ${r.status}`;
      return;
    }
    const json = await r.json();
    availableColumns = json.columns || [];
    renderColumns();
    status.innerText = `Found ${availableColumns.length} columns. Select columns and submit.`;
  } catch (err) {
    status.innerText = 'Network error: ' + err.message;
  }
});

function renderColumns(){
  if (!availableColumns.length) {
    colsArea.innerHTML = '<em>No columns found — try another file.</em>';
    return;
  }
  let html = '<strong>Select columns:</strong><div id="cols">';
  availableColumns.forEach(c => {
    html += `<label><input type="checkbox" value="${c}"> ${c}</label>`;
  });
  html += '</div>';
  colsArea.innerHTML = html;
}

submitBtn.addEventListener('click', async () => {
  if (!lastFile) return alert('Upload file and get columns first.');
  const selected = Array.from(colsArea.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  if (selected.length === 0) return alert('Select at least one column.');
  const email = document.getElementById('email').value.trim();
  if (!email) return alert('Enter recipient email.');
  const chartType = document.getElementById('chartType').value;

  const fd = new FormData();
  fd.append('file', lastFile);
  fd.append('columns', JSON.stringify(selected));
  fd.append('chart_type', chartType);
  fd.append('email', email);

  status.innerText = 'Uploading and requesting report...';
  submitBtn.disabled = true;
  try {
    const r = await fetch(GENERATE_URL, { method: 'POST', body: fd }); // Always POST
    if (!r.ok) {
      const txt = await r.text();
      status.innerText = `Generate request failed: ${r.status} ${txt}`;
    } else {
      status.innerText = 'Report request accepted — you will get an email when ready.';
    }
  } catch (err) {
    status.innerText = 'Network error: ' + err.message;
  } finally {
    submitBtn.disabled = false;
  }
});
</script>
</body>
</html>
